using System;
using System.Collections;
using System.Collections.Generic;
using System.Data.Common;
using HN.Code.Networking;
using Unity.Services.Authentication;
using Unity.Services.Core;
using Unity.Services.Lobbies;
using Unity.Services.Lobbies.Models;
using UnityEngine;

public class LobbyManager : MonoBehaviour
{
    public static LobbyManager Instance { get; private set; } //??????? ????? ???? ????

    public const string KEY_PLAYER_NAME = "PlayerName"; //?÷???? ??? KEY
    public const string KEY_PLAYER_CAR = "Car"; //?÷???? ????? KEY

    private string _playerName; //?÷???? ????? ????? ????
    private PlayerCartType _playerCartType; //????? ????? ????????

    [field: SerializeField] public CurrentPlayerData thisPlayerDataCompo;

    /// <summary>
    /// EventHandler?? ??????? Void?? ??????????? ???N?????. ?????? ?????? ??????? ?????? ???????????? ???? ????????
    /// ????????? ????? ???? object sender, EventArgs e?? ???? sender?? ?????? ?????????? ???,EventArgs ??????? ???? ???? 
    /// </summary>
    public event EventHandler OnLeftLobby; //???? ?????? ?????? ????? ??????????.

    public event EventHandler<LobbyEventArgs>
        OnJoinedLobby; //?κ? ????? ??????? ???? LobbyEventArgs?? Lobby ?????? ??????????.

    public event EventHandler<LobbyEventArgs>
        OnLobbyUpdated; //?κ? ?????????? ??????? ???? LobbyEventArgs?? Lobby ?????? ??????????.

    public event EventHandler<LobbyEventArgs>
        OnKickedFromLobby; //?κ?? ??????? ??????? ???? LobbyEventArgs?? Lobby ?????? ??????????.

    public event EventHandler<OnLobbyListChangedEventArgs>
        OnLobbyListChanged; //?κ???? ??? ??????? ???? OnLobbyListChangedEventArgs LobbyList?????? ??????????.

    public class LobbyEventArgs : EventArgs //?κ? ?????? ????? ?????
    {
        public Lobby lobby; //???? ??? ?κ? ??????????.
    }

    public class OnLobbyListChangedEventArgs : EventArgs //?κ? ??????? ??? ?κ? ????? ?????? ????? ?????
    {
        public List<Lobby> lobbyList = new List<Lobby>(); //?κ? ??????? ??????????.
    }

    private float
        heartbeatTimer =
            2.5f; //Unity Lobby?? 30????? ????????????? ?????????? ????????? ????? ??????? ???? ???????????? ????? ????(?????? ???)

    private float lobbyPollTimer = 2.5f; //?κ? ?????? ??????? ??? ????? ????? ????(??? ?÷????)
    private float refreshLobbyListTimer = 5f; //?κ? ?????ħ?ð?

    private Lobby joinedLobby; //??? ????? ?κ? ????? ????

    private void Awake()
    {
        //?????
        if (Instance == null) Instance = this;
        else
        {
            Destroy(gameObject);
            return;
        }

        _playerName = "Player_" + UnityEngine.Random.Range(1000, 9999);
        Authenticate(_playerName); //?÷???? ?????? ?α????? ????
    }

    private void Start()
    {
        InitializePlayerName();
    }

    private void Update()
    {
        HandleLobbyHeartbeat(); //?κ? ????? ??????? ???
        HandleLobbyPolling(); //?κ? ?????? ???????????? ???
        //HandleRefreshLobbyList();
    }

    #region Authentication

    public async void Authenticate(string playerName)
    {
        _playerName = playerName; //?÷???? ????? ??????.


        var options = new InitializationOptions().SetProfile(playerName); //?????????

        await UnityServices.InitializeAsync(options); //??????? ???? 

        await AuthenticationService.Instance.SignInAnonymouslyAsync(); //??? ?α???
    }

    #endregion

    public async void InitializePlayerName()
    {
        await thisPlayerDataCompo.SetPlayerData(_playerName);
    }

    #region Lobby Heartbeat & Polling

    private async void HandleLobbyHeartbeat()
    {
        if (IsLobbyHost()) //?κ? ???????
        {
            heartbeatTimer -= Time.deltaTime; //?κ? ??? ???? ???? ????
            if (heartbeatTimer < 0f) //????? 0???? ??????
            {
                heartbeatTimer = 15f; //???? ????

                try
                {
                    await LobbyService.Instance
                        .SendHeartbeatPingAsync(joinedLobby.Id); //?κ?? ?κ? ????????? ?????? ?κ? ??????´?.
                    Debug.Log("Heartbeat sent");
                }
                catch (Exception e)
                {
                    Debug.LogError("Heartbeat failed: " + e);
                }
            }
        }
    }

    private async void HandleLobbyPolling()
    {
        if (joinedLobby != null) //?κ? ????????
        {
            lobbyPollTimer -= Time.deltaTime; //?κ? ????????? ???? ???? ????
            if (lobbyPollTimer < 0f) //????? 0??????????
            {
                lobbyPollTimer = 1.1f; //???? ????

                try
                {
                    joinedLobby = await LobbyService.Instance.GetLobbyAsync(joinedLobby.Id); //?κ? ?????? ??????.

                    OnLobbyUpdated?.Invoke(this,
                        new LobbyEventArgs { lobby = joinedLobby }); //?κ? ????????? ?????? ?????? ???????.

                    if (!IsPlayerInLobby()) //?÷???? ?κ? ???????????(????????)
                    {
                        Debug.Log("Kicked from Lobby!");
                        OnKickedFromLobby?.Invoke(this,
                            new LobbyEventArgs { lobby = joinedLobby }); //???? ???????? ?????? ???????.
                        joinedLobby = null; //????? ?κ????? ??????.
                    }
                }
                catch (LobbyServiceException e)
                {
                    Debug.LogWarning("Lobby polling failed: " + e);
                    joinedLobby = null;
                }
            }
        }
    }

    #endregion

    #region Lobby Management

    public Lobby GetJoinedLobby() => joinedLobby; //??? ?????????? ?κ? ??????? ?????? ???

    public bool IsLobbyHost() //?κ? ?????? ?´??? ?????? ???
    {
        return joinedLobby != null &&
               joinedLobby.HostId ==
               AuthenticationService.Instance
                   .PlayerId; //???? ?κ? ????ID?? ?÷???? ID?? ???????????? ???? false?????? true?? ???????.
    }

    private bool IsPlayerInLobby() //?÷???? ?κ? ????????? ?????? ????
    {
        if (joinedLobby == null) return false; //?κ?????? false?? ???????.

        foreach (Player player in joinedLobby.Players) //?κ???? ?÷???? ?????? ????
        {
            if (player.Id == AuthenticationService.Instance.PlayerId) //???? ?÷????ID?? ?????? ??????
                return true; //?????? true?? ???????.
        }

        return false; //????? false?? ???????.
    }

    private Player GetPlayer(string playerName = null, string selectedCart = "") //?÷???? ??????? ?????? ???
    {
        try
        {
            if (string.IsNullOrEmpty(playerName)) //?÷???? ????? ?????
                playerName = _playerName; //???? ????? ??????.

            return new Player(
                AuthenticationService.Instance.PlayerId, //???? ?α????? ?÷?????? ???? ID?? ??????
                null, //???????? 
                new Dictionary<string, PlayerDataObject> //Ŀ???? ?÷???? ??????
                {
                    {
                        KEY_PLAYER_NAME, new PlayerDataObject(PlayerDataObject.VisibilityOptions.Public, playerName)
                    }, //?÷???? KEY??????? ????? KEY?????? ??? ?÷???? ??????? ????????? ???????ο? ??????? ??????.(?÷???? ????? ??????? ?????? ???? ???????)
                    {
                        KEY_PLAYER_CAR, new PlayerDataObject(PlayerDataObject.VisibilityOptions.Public, selectedCart)
                    } //?÷???? ????? KEY??????? ????? KEY?????? ??? ?÷???? ??????? ????????? ???????ο? ??????? ??????.
                }
            );
        }
        catch (Exception e)
        {
            Debug.LogError("Failed to get player data: " + e);
            return null;
        }
    }


    public async void
        CreateLobby(string lobbyName, int maxPlayers) //?κ? ???? ?????? ??? ?κ?????? ??? ?÷???? ????????? ??´?.
    {
        if (UnityServices.State !=
            ServicesInitializationState
                .Initialized) //????? ?????? ???? ????????????? ?κ? ??????????? ?????? ???? ?????????????.
        {
            Debug.LogError("Unity Services not initialized. Cannot create lobby.");
            return;
        }

        if (!AuthenticationService.Instance
                .IsSignedIn) //?????????? ?α??ξ???? ???????? ???? ?α??? ??????????? ?????? ???? ?κ? ????????? ?????.
        {
            Debug.LogError("Not signed in. Cannot create lobby.");
            return;
        }

        try
        {
            var options = new CreateLobbyOptions //?κ? ???? ??????
            {
                Player = GetPlayer(thisPlayerDataCompo.GivePlayerData().UserName,
                    thisPlayerDataCompo.GivePlayerData().CarType), //?????? ???
                IsPrivate = false, //???????????´?.
            };

            joinedLobby =
                await LobbyService.Instance.CreateLobbyAsync(lobbyName, maxPlayers,
                    options); //?κ? ???? ?? ????? ??????? ?κ??? ??????.

            OnJoinedLobby?.Invoke(this,
                new LobbyEventArgs { lobby = joinedLobby }); //?κ? ?????? ?????? ???????? ?κ? ?????? ??????.

            Debug.Log("Lobby Created: " + joinedLobby.Name);
        }
        catch (LobbyServiceException e)
        {
            Debug.LogError("CreateLobby failed: " + e);
        }
        catch (Exception e)
        {
            Debug.LogError("CreateLobby failed: " + e);
        }
    }

    public async void RefreshLobbyList() //?κ? ?????ħ
    {
        if (UnityServices.State !=
            ServicesInitializationState
                .Initialized) //????? ?????? ???? ????????????? ?κ? ??????????? ?????? ???? ?????ħ???????????.
        {
            Debug.LogWarning("Unity Services not initialized yet. Cannot refresh lobby list.");
            return;
        }

        if (!AuthenticationService.Instance
                .IsSignedIn) //?????????? ?α??ξ???? ???????? ???? ?α??? ??????????? ?????? ???? ?????ħ????????? ?????.
        {
            Debug.LogWarning("Not signed in. Cannot refresh lobby list.");
            return;
        }

        try
        {
            var options = new QueryLobbiesOptions //Unity Lobby???? ?κ? ????? ?? ?????? ??????? ??? ?????.
            {
                Count = 25, //???κ?
                Filters = new List<QueryFilter>
                {
                    //????? ??? ?κ? ???????????? ????
                    new QueryFilter(
                        field: QueryFilter.FieldOptions.AvailableSlots,
                        op: QueryFilter.OpOptions.GT,
                        value: "0"
                    )
                },
                Order = new List<QueryOrder> //????
                {
                    //???? ???? ?????? ?κ??? ????
                    new QueryOrder(
                        asc: false,
                        field: QueryOrder.FieldOptions.Created
                    )
                }
            };

            QueryResponse response = await LobbyService.Instance.QueryLobbiesAsync(options); //????? ?´? ?κ? ????????

            var validLobbies = new List<Lobby>(); //???????? ?κ????? ????
            foreach (var lobby in response.Results) //????? ????? ??????? ??????.
            {
                if (!lobby.IsLocked && !string.IsNullOrEmpty(lobby.HostId)) //?κ? ????????? ?????????????? ?κ?? ???????.
                {
                    validLobbies.Add(lobby); //???????? ???????? ??????.
                }
            }

            OnLobbyListChanged?.Invoke(this, new OnLobbyListChangedEventArgs
            {
                lobbyList = validLobbies
            }); //?κ? ????? ?????? ???????.

            Debug.Log($"Lobby List Refreshed: {validLobbies.Count}/{response.Results.Count} (after filtering)");
        }
        catch (LobbyServiceException e)
        {
            Debug.LogError("RefreshLobbyList failed: " + e);
        }
        catch (Exception e)
        {
            Debug.LogError("RefreshLobbyList failed: " + e);
        }
    }


    public async void JoinLobby(Lobby lobby) //?κ? ????? ?????? ???
    {
        if (UnityServices.State !=
            ServicesInitializationState
                .Initialized) //????? ?????? ???? ????????????? ?κ? ??????????? ?????? ???? ????????????????????.
        {
            Debug.LogError("Unity Services not initialized. Cannot join lobby.");
            return;
        }

        if (!AuthenticationService.Instance
                .IsSignedIn) //?????????? ?α??ξ???? ???????? ???? ?α??? ??????????? ?????? ???? ??????????? ?????.
        {
            Debug.LogError("Not signed in. Cannot join lobby.");
            return;
        }

        try
        {
            joinedLobby = await LobbyService.Instance.JoinLobbyByIdAsync(lobby.Id,
                new JoinLobbyByIdOptions //?κ????????? ????? ?????? ?????? ????????? ???? ????
                {
                    Player = GetPlayer(thisPlayerDataCompo.GivePlayerData().UserName,
                        thisPlayerDataCompo.GivePlayerData().CarType)
                });

            OnJoinedLobby?.Invoke(this,
                new LobbyEventArgs { lobby = joinedLobby }); //?κ? ?????? ?????? ??????? ?κ??????? ???????.

            Debug.Log("Joined Lobby: " + joinedLobby.Name);
        }
        catch (LobbyServiceException e)
        {
            Debug.LogError("JoinLobby failed: " + e);
        }
        catch (Exception e)
        {
            Debug.LogError("JoinLobby failed: " + e);
        }
    }

    public async void KickPlayer(string playerId) //?÷???? ????? ?? ?????? ??? 
    {
        if (!IsLobbyHost()) return; //?????? ????? ??? ??????? ???
        if (joinedLobby == null) return; //?κ? ????? ??? ????????? ???

        try
        {
            await LobbyService.Instance.RemovePlayerAsync(joinedLobby.Id, playerId); //?κ?? ?÷???? ????
            Debug.Log($"Kicked player: {playerId}");
        }
        catch (LobbyServiceException e)
        {
            Debug.LogError("KickPlayer failed: " + e);
        }
    }

    public async void LeaveLobby() //?κ? ?????? ?????? ???
    {
        if (joinedLobby == null) return; //?κ? ??????????? ???

        try
        {
            await LobbyService.Instance.RemovePlayerAsync(joinedLobby.Id,
                AuthenticationService.Instance.PlayerId); //?κ?? ???????? ????????? ???? ??? ??? ????

            Debug.Log("Left Lobby: " + joinedLobby.Name);

            joinedLobby = null; //?????? ?κ? ???? ?κ?? ????
            OnLeftLobby?.Invoke(this, EventArgs.Empty); //?κ? ???? ???? ????
        }
        catch (LobbyServiceException e)
        {
            Debug.LogError("LeaveLobby failed: " + e);
        }
    }

    public async void StartGame()
    {
        if (!IsLobbyHost() || joinedLobby == null) return;

        try
        {
            bool result = await HostSingleton.Instance.GameManager.MakeJoinCode(GetJoinedLobby().Players.Count);
            
            if (result == false)
            {
                Debug.LogError("참가 코드 생성 실패");
                return;
            }
            print($"JoinCode: {HostSingleton.Instance.JoinCode}");

            var updateOptions = new UpdateLobbyOptions
            {
                Data = new Dictionary<string, DataObject>
                {
                    { "GameStarted", new DataObject(DataObject.VisibilityOptions.Public, "true") },
                    { "JoinCode", new DataObject(DataObject.VisibilityOptions.Public, HostSingleton.Instance.JoinCode) }
                }
            };

            joinedLobby = await LobbyService.Instance.UpdateLobbyAsync(joinedLobby.Id, updateOptions);

            Debug.Log("Game started! Signal sent to all players.");
        }
        catch (LobbyServiceException e)
        {
            Debug.LogError("StartGame failed: " + e);
        }
    }

    #endregion

    #region Helpers

    private void HandleRefreshLobbyList()
    {
        if (UnityServices.State == ServicesInitializationState.Initialized &&
            AuthenticationService.Instance.IsSignedIn)
        {
            refreshLobbyListTimer -= Time.deltaTime;
            if (refreshLobbyListTimer < 0f)
            {
                refreshLobbyListTimer = 5f;
                RefreshLobbyList();
            }
        }
    }

    public bool IsServiceReady()
    {
        try
        {
            return UnityServices.State == ServicesInitializationState.Initialized &&
                   AuthenticationService.Instance.IsSignedIn;
        }
        catch
        {
            return false;
        }
    }

    #endregion
}